{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
  <h2>Validar Identidad</h2>

  {% if error %}
    <div class="alert alert-danger">{{ error }}</div>
  {% endif %}

  <!-- Botones para seleccionar modo -->
  <div class="mb-4 text-center">
    <button class="btn btn-outline-primary me-2" onclick="mostrarFormulario('manual')">Validación por RUT</button>
    <button class="btn btn-outline-success" onclick="mostrarFormulario('qr')">Validación por QR</button>
  </div>

  <!-- Formulario Manual -->
  <div id="form-manual" style="display: none;">
    <form method="post" id="valida-form">
      {% csrf_token %}
      <label for="rut_input">Escribe el RUT</label>
      <input type="text" name="rut" id="rut_input" class="form-control" placeholder="Ej: 20884803-8" required autofocus pattern="[0-9]{7,8}-[0-9Kk]{1}">
      <button type="submit" class="btn btn-primary mt-3">Validar</button>
    </form>
  </div>

  <!-- Formulario con QR -->
  <div id="form-qr" style="display: none;">
    <label>Escanea el QR desde la credencial</label>
    <div id="reader" style="width: 100%; max-width: 400px; margin: auto;"></div>
    <form id="form-rut" method="post" action="{% url 'validar_rut' %}" class="mt-3">
      {% csrf_token %}
      <input type="text" name="rut" id="rut_qr" class="form-control text-center" readonly required>
      <button class="btn btn-success mt-2" type="submit">Validar RUT</button>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Librería QR -->
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

<script>
  function mostrarFormulario(tipo) {
    document.getElementById('form-manual').style.display = (tipo === 'manual') ? 'block' : 'none';
    document.getElementById('form-qr').style.display = (tipo === 'qr') ? 'block' : 'none';

    // Si se elige QR, inicia el escáner (una sola vez)
    if (tipo === 'qr' && !window.qrStarted) {
      const html5QrcodeScanner = new Html5QrcodeScanner(
        "reader",
        { fps: 10, qrbox: 250 },
        false
      );

      html5QrcodeScanner.render(function onScanSuccess(decodedText) {
        document.getElementById("rut_qr").value = decodedText;
        document.getElementById("form-rut").submit();
        html5QrcodeScanner.clear(); // Detiene el escáner
      });

      window.qrStarted = true;
    }
  }

  // Submitear con Enter en input manual
  document.addEventListener('DOMContentLoaded', function () {
    const input = document.getElementById('rut_input');
    if (input) {
      input.addEventListener('keydown', function (e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          document.getElementById('valida-form').submit();
        }
      });
    }

    // Mostrar formulario manual por defecto al cargar
    mostrarFormulario('manual');
  });
</script>
{% endblock %}